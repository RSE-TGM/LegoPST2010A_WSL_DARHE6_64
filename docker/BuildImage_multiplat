#!/bin/bash
#
# Versione multipiattorma
# PREREQUISITO: installare prima buildx così:
# docker buildx create --name mybuilder --use
#
IMAGE_NAME="aguagliardi/legopst_multi:2.0"
PROCEED_AUTOMATICALLY=false
DOCKERFILE_PATH="LegoPST2010A_WSL_DARHE6_64/docker/Dockerfile_LegoPST"
CONTEXT_PATH="."

echo "Building immagine Docker: $IMAGE_NAME"
echo "NOTA: Ora l'immagine supporta creazione utenti dinamici"

# Controlla se Docker è installato
if ! command -v docker >/dev/null 2>&1; then
    echo "---------------------------------------------------------------------"
    echo "ATTENZIONE: Docker non sembra essere installato o non è nel PATH."
    echo "            L'immagine Docker non verrà costruita."
    echo "            Per favore, installa Docker per procedere con la build."
    echo "---------------------------------------------------------------------"
    exit 0
fi

# Analizza i parametri della riga di comando
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -y|--yes) PROCEED_AUTOMATICALLY=true; shift ;;
        *) echo "Parametro sconosciuto passato a BuildImage: $1"; exit 1 ;;
    esac
done

build_logic() {
    echo " "
    echo "---------------------------------------------------------------------"
    echo " Docker installato"
    echo " Building dell'immagine Docker $IMAGE_NAME"
    echo " Modalità: Utenti dinamici (non serve più specificare UID/GID)"
    echo "---------------------------------------------------------------------"

    # Build dell'immagine senza build arguments (non servono più)
    (cd ../.. && \
     docker buildx build --platform linux/amd64,linux/arm64 \
        -t "$IMAGE_NAME" --push \
        --file "$DOCKERFILE_PATH" \
        "$CONTEXT_PATH" \
    )

    local build_status=$?
    if [ $build_status -eq 0 ]; then
        echo "--------------> Fine building dell'immagine $IMAGE_NAME <---------------"
        echo "L'immagine supporta ora la creazione dinamica di utenti"
        echo "Gli utenti verranno creati automaticamente al lancio del container"
    else
        echo "Errore nel building dell'immagine (exit code: $build_status)"
    fi
    return $build_status
}

if [ "$PROCEED_AUTOMATICALLY" = true ]; then
    echo "Opzione -y rilevata, procedo automaticamente con la build."
    build_logic
    exit $?
else
    while true; do
        echo " "
        echo "Verrà costruita l'immagine Docker: $IMAGE_NAME"
        echo "Modalità: Creazione utenti dinamici"
        read -p "Procedo? (y/n) " yn

        case $yn in
            [yY] )
                build_logic
                exit $?;;
            [nN] )
                echo "Operazione annullata dall'utente."
                exit 0;;
            * )
                echo "Risposta non valida. Per favore, inserisci 'y' o 'n'.";;
        esac
    done
fi


