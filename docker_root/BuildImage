#!/bin/bash

versione="aguagliardi/legopst:latest"
PROCEED_AUTOMATICALLY=false
DOCKERFILE_PATH="LegoPST2010A_WSL_DARHE6_64/docker/Dockerfile_LegoPST"
CONTEXT_PATH="." # Assumendo che sia la root del progetto rispetto a dove viene eseguito cd ../..

# Controlla se Docker è installato PRIMA di chiedere all'utente
if ! command -v docker >/dev/null 2>&1; then
    echo "---------------------------------------------------------------------"
    echo "ATTENZIONE: Docker non sembra essere installato o non è nel PATH."
    echo "            L'immagine Docker non verrà costruita."
    echo "            Per favore, installa Docker per procedere con la build."
    echo "---------------------------------------------------------------------"
    exit 0 # Esce con successo, come richiesto, solo segnalando
fi

# Analizza i parametri della riga di comando
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -y|--yes) PROCEED_AUTOMATICALLY=true; shift ;;
        *) echo "Parametro sconosciuto passato a BuildImage: $1"; exit 1 ;; # Errore se parametro non valido
    esac
done

build_logic() {
    echo " "
    echo "---------------------------------------------------------------------"
    echo " Docker installato"
    echo " Building dell'immagine Docker $versione"
    echo "---------------------------------------------------------------------"

    # set -x # Abilita il debug se necessario
    # Assicurati che il percorso per cd sia corretto
    # Questo cd è relativo alla posizione di BuildImage, non del Makefile
    # Se BuildImage è in LegoPST2010A_WSL_DARHE6_64/docker/, allora cd ../.. è corretto.
    (cd ../.. && \
     docker build -t "$versione" --file "$DOCKERFILE_PATH" "$CONTEXT_PATH" \
    )
    # Nota: --debug è un flag per il client docker, non per il comando build.
    # Se vuoi debug dal demone, devi configurare il demone.
    # Per più output dal client docker build, potresti non aver bisogno di flag speciali,
    # o considera variabili d'ambiente come DOCKER_CLIENT_TIMEOUT.

    local build_status=$?
    # set +x
    if [ $build_status -eq 0 ]; then
        echo "--------------> Fine building dell'immagine $versione <---------------"
    else
        echo "Errore nel building dell'immagine (exit code: $build_status)"
    fi
    return $build_status
}

if [ "$PROCEED_AUTOMATICALLY" = true ]; then
    echo "Opzione -y rilevata, procedo automaticamente con la build."
    build_logic
    exit $? # Esce con lo stato della build
else
    while true; do
        echo " "
        echo "Verrà costruita l'immagine Docker: $versione"
        read -p "Procedo? (y/n) " yn

        case $yn in
            [yY] )
                build_logic
                exit $?;; # Esce con lo stato della build
            [nN] )
                echo "Operazione annullata dall'utente."
                exit 0;;
            * )
                echo "Risposta non valida. Per favore, inserisci 'y' o 'n'.";;
        esac
    done
fi